#include "fir.h"

#include <algorithm> // std::fill

// FIR filter coefficients (inverse-sinc / SX1255 equalization)
namespace
{
constexpr std::array<float, LinHTFir::NUM_TAPS> SX1255_EQ_TAPS = {
     3.45379446e-06f, -7.44373709e-06f,  1.99382256e-05f, -4.25078410e-05f,
     7.77895351e-05f, -1.29448329e-04f,  2.02125473e-04f, -3.01367617e-04f,
     4.33530620e-04f, -6.05651323e-04f,  8.25279728e-04f, -1.10026470e-03f,
     1.43848622e-03f, -1.84752771e-03f,  2.33428252e-03f, -2.90448953e-03f,
     3.56219121e-03f, -4.30910950e-03f,  5.14393070e-03f, -6.06148940e-03f,
     7.05183452e-03f, -8.09915382e-03f,  9.18051571e-03f, -1.02643725e-02f,
     1.13087301e-02f, -1.22588495e-02f,  1.30442672e-02f, -1.35748140e-02f,
     1.37351298e-02f, -1.33769015e-02f,  1.23075641e-02f, -1.02734459e-02f,
     6.93396394e-03f, -1.82104185e-03f, -5.72659762e-03f,  1.66732917e-02f,
    -3.24770538e-02f,  5.54343300e-02f, -8.93342343e-02f,  1.40769976e-01f,
    -2.21934464e-01f,  3.56985825e-01f, -5.97442725e-01f,  1.06000478e+00f,
    -1.99968683e+00f,  3.63384209e+00f, -1.99968683e+00f,  1.06000478e+00f,
    -5.97442725e-01f,  3.56985825e-01f, -2.21934464e-01f,  1.40769976e-01f,
    -8.93342343e-02f,  5.54343300e-02f, -3.24770538e-02f,  1.66732917e-02f,
    -5.72659762e-03f, -1.82104185e-03f,  6.93396394e-03f, -1.02734459e-02f,
     1.23075641e-02f, -1.33769015e-02f,  1.37351298e-02f, -1.35748140e-02f,
     1.30442672e-02f, -1.22588495e-02f,  1.13087301e-02f, -1.02643725e-02f,
     9.18051571e-03f, -8.09915382e-03f,  7.05183452e-03f, -6.06148940e-03f,
     5.14393070e-03f, -4.30910950e-03f,  3.56219121e-03f, -2.90448953e-03f,
     2.33428252e-03f, -1.84752771e-03f,  1.43848622e-03f, -1.10026470e-03f,
     8.25279728e-04f, -6.05651323e-04f,  4.33530620e-04f, -3.01367617e-04f,
     2.02125473e-04f, -1.29448329e-04f,  7.77895351e-05f, -4.25078410e-05f,
     1.99382256e-05f, -7.44373709e-06f,  3.45379446e-06f
};
} // namespace

LinHTFir::LinHTFir()
{
    reset();
}

void LinHTFir::reset()
{
    std::fill(ring.begin(), ring.end(),
              std::complex<float>(0.f, 0.f));
    pos = 0;
}

std::complex<float> LinHTFir::processSample(std::complex<float> x)
{
    ring[pos] = x;

    float re = 0, im = 0;
    size_t idx = pos;

    for(size_t k = 0; k < NUM_TAPS; ++k)
    {
        const auto &r = ring[idx];
        re += r.real() * SX1255_EQ_TAPS[k];
        im += r.imag() * SX1255_EQ_TAPS[k];

        if(idx == 0)
        {
            idx = HISTORY_LEN - 1;
        }
        else
        {
            idx--;
        }
    }

    if(++pos >= HISTORY_LEN)
    {
        pos = 0;
    }

    return {re, im};
}
